<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Daily Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #C49A93 0%, #B08580 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: #F5F1EA;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            max-width: 700px;
            width: 100%;
            padding: 48px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .edit-mode-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: #E5E0D8;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-mode-toggle:hover {
            background: #C49A93;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(196, 154, 147, 0.3);
        }

        .edit-mode-toggle.active {
            background: #C49A93;
            color: white;
        }

        .header h1 {
            color: #2D2D2D;
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .day-display {
            font-size: 1em;
            color: #B08580;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .day-navigation {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }

        .day-nav-btn {
            background: #E5E0D8;
            color: #5A5A5A;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-nav-btn:hover {
            background: #C49A93;
            color: white;
            transform: translateY(-1px);
        }

        .step {
            margin-bottom: 20px;
            padding: 24px;
            background: #FFFFFF;
            border: 1px solid #E5E0D8;
            border-radius: 16px;
            transition: all 0.2s ease;
            position: relative;
        }

        .step.completed {
            background: #FAF8F4;
            border-color: #DDD9D0;
        }

        .step.completed .step-title {
            color: #999;
            text-decoration: line-through;
        }

        .step:hover {
            box-shadow: 0 4px 16px rgba(196, 154, 147, 0.1);
            transform: translateY(-2px);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .drag-handle {
            cursor: grab;
            color: #B08580;
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.2s ease;
            user-select: none;
        }

        .edit-mode .drag-handle {
            opacity: 0.6;
        }

        .drag-handle:hover {
            opacity: 1 !important;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .step.dragging {
            opacity: 0.5;
        }

        .step-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #C49A93;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 1.15em;
            color: #2D2D2D;
            margin-bottom: 0;
            font-weight: 600;
            flex: 1;
            letter-spacing: -0.3px;
        }

        .edit-btn {
            background: #E5E0D8;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-mode .edit-btn {
            opacity: 1;
        }

        .edit-btn:hover {
            background: #C49A93;
            color: white;
            transform: translateY(-1px);
        }

        .step-content {
            line-height: 1.7;
            color: #5A5A5A;
            font-size: 0.95em;
            margin-top: 16px;
            margin-left: 38px;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .timer-btn {
            background: #C49A93;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
            flex: 0;
        }

        .timer-btn:hover {
            background: #B08580;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 154, 147, 0.3);
        }

        .timer-btn:active {
            transform: translateY(0);
        }

        .reflection-sections {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reflection-section {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .reflection-btn {
            background: #E5E0D8;
            color: #5A5A5A;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .reflection-btn:hover {
            background: #DDD9D0;
            transform: translateY(-1px);
        }

        .reflection-btn.active {
            background: #C49A93;
            color: white;
        }

        .reflection-content {
            margin-top: 12px;
            margin-left: 20px;
        }

        .reflection-item {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .step-content p {
            margin-bottom: 12px;
        }

        .step-content strong {
            color: #3D3D3D;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #F5F1EA;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #2D2D2D;
            font-size: 1.5em;
            margin-bottom: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #5A5A5A;
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E5E0D8;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
            background: white;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #C49A93;
            box-shadow: 0 0 0 3px rgba(196, 154, 147, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .item-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .item-row input {
            flex: 1;
        }

        .delete-item-btn {
            background: #E5E0D8;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .delete-item-btn:hover {
            background: #d68a7f;
            color: white;
        }

        .add-item-btn {
            background: #E5E0D8;
            color: #5A5A5A;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .add-item-btn:hover {
            background: #C49A93;
            color: white;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.primary {
            background: #C49A93;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #B08580;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 154, 147, 0.3);
        }

        .modal-btn.secondary {
            background: #E5E0D8;
            color: #5A5A5A;
        }

        .modal-btn.secondary:hover {
            background: #DDD9D0;
        }

        .modal-btn.danger {
            background: #d68a7f;
            color: white;
        }

        .modal-btn.danger:hover {
            background: #c77a6f;
        }

        .add-section-btn {
            background: #E5E0D8;
            color: #5A5A5A;
            border: 2px dashed #C49A93;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 12px;
            opacity: 0;
        }

        .edit-mode .add-section-btn {
            opacity: 1;
        }

        .add-section-btn:hover {
            background: #C49A93;
            color: white;
            border-style: solid;
        }

        .reset-btn {
            background: #E5E0D8;
            color: #5A5A5A;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 24px;
            width: 100%;
            opacity: 0;
        }

        .edit-mode .reset-btn {
            opacity: 1;
        }

        .reset-btn:hover {
            background: #d68a7f;
            color: white;
            transform: translateY(-1px);
        }

        .day-navigation {
            transition: opacity 0.2s ease;
        }

        .edit-mode .day-navigation {
            opacity: 0;
            pointer-events: none;
        }

        .day-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .day-tab {
            background: #E5E0D8;
            color: #5A5A5A;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-tab.active {
            background: #C49A93;
            color: white;
        }

        .day-tab:hover {
            background: #C49A93;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="edit-mode-toggle" onclick="toggleEditMode()">‚úèÔ∏è</button>
            <h1>My Daily Practice</h1>
            <div class="day-display" id="dayDisplay"></div>
        </div>
        
        <div id="routine"></div>

        <button class="add-section-btn" onclick="openAddSectionModal()">+ Add New Section</button>
        
        <button class="reset-btn" onclick="confirmReset()">Reset to Defaults</button>
        
        <div class="day-navigation" style="margin-top: 20px;">
            <button class="day-nav-btn" onclick="previousDay()">‚Üê Previous Day</button>
            <button class="day-nav-btn" onclick="nextDay()">Next Day ‚Üí</button>
        </div>
    </div>

    <!-- Modal for editing -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlayClick(event)">
        <div class="modal" id="modalContent"></div>
    </div>

    <script>
        let currentDayIndex = new Date().getDay();
        let editMode = false;
        let timerInterval = null;
        let wakeLock = null;
        let draggedElement = null;

        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Version for data structure - increment when default data changes significantly
        const DATA_VERSION = 4;

        // Default data
        const defaultData = {
            sections: [
                {
                    id: 'meditation',
                    title: 'Meditation',
                    type: 'timer',
                    order: 1
                },
                {
                    id: 'reflections',
                    title: 'Meditation Reflections',
                    type: 'reflections',
                    order: 2
                },
                {
                    id: 'gratitude',
                    title: 'Gratitude for what\'s already here',
                    type: 'daily',
                    order: 3
                },
                {
                    id: 'visualization',
                    title: 'Visualization of my goals',
                    type: 'daily',
                    order: 4
                },
                {
                    id: 'journaling',
                    title: 'Journaling',
                    type: 'simple',
                    order: 5,
                    content: 'Let your thoughts flow onto the page without judgment or editing.'
                },
                {
                    id: 'reading',
                    title: 'Reading',
                    type: 'simple',
                    order: 6,
                    content: 'Read a few pages of something nourishing or inspiring.'
                },
                {
                    id: 'exercise',
                    title: 'Exercise',
                    type: 'simple',
                    order: 7,
                    content: 'Gentle movement, yoga, stretching, or walking.'
                }
            ],
            timerPresets: [10, 20, 30],
            reflectionCategories: {
                impermanence: {
                    title: 'Impermanence',
                    items: [
                        'This body will age, become ill, and die.',
                        'Death is certain; The time of death is uncertain.',
                        'This moment is part of preparing for death.',
                        'There is no guarantee of time remaining.',
                        'All beings experience suffering and separation.',
                        'Nothing remains fixed; all conditions change moment by moment.',
                        'Clinging does not prevent loss or pain.',
                        'Relationships, possessions, and roles will change or end.'
                    ]
                },
                renunciation: {
                    title: 'Renunciation',
                    items: [
                        'There\'s no such thing as a person who perfected both Dharma practice and worldly life.',
                        'There are no solutions to the suffering of samsara and it cannot be fixed, true happiness cannot be found there.',
                        'However positive worldly life may seem, ultimately it will fail.',
                        'Until we see samsara as a terminal illness, genuine aspiration to practice cannot arise.',
                        'Disgust and revulsion for samsara can be trained; repeated reflection develops genuine renunciation.',
                        'Seeking liberation is more important than immediately finding it.',
                        'Worldly achievements cannot bring ultimate satisfaction.',
                        'Wealth, status, or comfort are unstable, so any attachment to them will lead to suffering.',
                        'Recognizing samsara\'s limitations clarifies the path to freedom.',
                        'Spiritual seeking arises naturally when samsara\'s insufficiency is recognized.'
                    ]
                },
                emptiness: {
                    title: 'Emptiness',
                    items: [
                        'Nothing exists independently; all phenomena arise in relation.',
                        'There is no fixed self in the flow of mind and body.',
                        'Thoughts and sensations appear, change, and dissolve without a controller.',
                        'Events arise due to causes and conditions, not by themselves.',
                        'The sense of a solid, separate self dissolves when awareness is seen directly.',
                        'What we call \'I\' is a process of sensing, thinking, and acting, not an independent object.',
                        'The boundary between inner and outer experience arises in the mind, not in reality itself.',
                        'Subject and object are not two fixed things; they are co‚Äëarising events.',
                        'Awareness does not belong to a separate self ‚Äî it is the field in which everything appears.'
                    ]
                },
                selfCompassion: {
                    title: 'Self-Compassion',
                    items: [
                        'How do I feel right now?',
                        'Difficulty arises for me, as it arises for all beings.',
                        'May I be free of suffering, anger, irritation, pain, addictions, attachment.',
                        'The body and mind experience tension and ease.',
                        'All beings, including this one, face impermanence.',
                        'Discomfort and struggle are part of the human condition.',
                        'No experience needs to be fixed; it is as it is.',
                        'May I have all that I wish for myself',
                        'May I have all that I need to serve all beings',
                        'May everything that happens in my life will help me get closer to Enlightenment'
                    ]
                },
                bodhicitta: {
                    title: 'Bodhicitta',
                    items: [
                        'All my happiness comes from the kindness of beings.',
                        'All beings have been my mothers in past lives.',
                        'The purpose of my life is to attain Buddhahood for the benefit of all beings.',
                        'I practice not for myself alone, but for the freedom of all beings.',
                        'May my actions be guided by care and compassion.',
                        'The kindness of others supports every moment of my life.',
                        'Compassion arises naturally when we recognize the suffering of beings.',
                        'Every being I encounter has shown me some form of care in the past.',
                        'May my practice benefit all beings.'
                    ]
                },
                dedication: {
                    title: 'Dedication & Aspiration',
                    items: [
                        'May all beings be free from suffering and its causes.',
                        'May all beings find happiness and peace.',
                        'May I continue steadily on the path, with clarity and awareness.',
                        'May I have the resources and conditions to sustain my practice.',
                        'May I have a fulfilling and rewarding job',
                        'May my actions benefit others as well as myself.',
                        'May my life be a support to others\' practice and freedom.',
                        'May all beings have the conditions to practice Dharma.',
                        'May clarity and insight arise naturally in my mind.',
                        'May the seeds of awakening grow in all beings.'
                    ]
                }
            },
            dailyContent: {
                visualization: {
                    day0: '<p><strong>Work:</strong> I have a meaningful job, working in mindfulness and giving my full potential in a selfless way. The work nourishes me and I help others.</p>',
                    day1: '<p><strong>Financial:</strong> I have enough money to feel calm about it. I have money to donate and give to others. I feel calm when I check my financial situation. I earn enough money to sustain myself.</p>',
                    day2: '<p><strong>Relationships:</strong> I have good heart friends that support and help me and I do that for them. I feel friendship with everyone I meet. I feel compassion and love for all beings, including the ones who harm others.</p>',
                    day3: '<p><strong>Practice:</strong> I practice everyday in the morning, I keep Bodhichitta in mind, so everything I do during the day is in the means to help me reach full enlightenment for the benefit of others.</p>',
                    day4: '<p><strong>Enlightenment:</strong> Imagine light coming from Buddha Shakyamuni filling me with all his qualities of enlightenment: Love, compassion, happiness, wisdom, realization of emptiness, bodhichitta, renunciation, devotion.</p>',
                    day5: '<p><strong>Physical Health:</strong> My body is healthy, I have a lot of energy and strength, digestion is working well, my body will live for a long time. I exercise daily.</p>',
                    day6: '<p><strong>Mental Health:</strong> I am fulfilled and happy, calm, working for other\'s benefit, joyful and compassionate.</p>'
                },
                gratitude: {
                    day0: '<p><strong>Body:</strong> My body, its health, different parts, functions and abilities.</p>',
                    day1: '<p><strong>Family and Friends:</strong> My family, friends, coworkers and acquaintances.</p>',
                    day2: '<p><strong>Money:</strong> My money, pension, savings, financial support in time of need or emergency.</p>',
                    day3: '<p><strong>Abilities:</strong> My abilities, talents, knowledge, education.</p>',
                    day4: '<p><strong>Possessions:</strong> Food, electronics, car, clothes, shoes, cosmetics, furniture. Also electricity, water, sun, plants, air.</p>',
                    day5: '<p><strong>Spiritual Path:</strong> Meeting the Dharma, practicing, potential of my mind, faith, teachers, dharma centers.</p>',
                    day6: '<p><strong>Past Support by Others:</strong> Parents, nannies, teachers, professors, food suppliers, cooks, transportation, medical assistance, government facilities, therapists.</p>'
                }
            }
        };

        // Load customizations from localStorage
        function loadCustomizations() {
            const saved = localStorage.getItem('miracle-morning-customizations');
            const savedVersion = localStorage.getItem('miracle-morning-data-version');
            
            if (saved) {
                const data = JSON.parse(saved);
                
                // Check if we need to update from old version
                if (!savedVersion || parseInt(savedVersion) < DATA_VERSION) {
                    console.log('Updating data structure to version', DATA_VERSION);
                    
                    // Update reflection categories, visualization, and gratitude with new full content
                    data.reflectionCategories = defaultData.reflectionCategories;
                    data.dailyContent = data.dailyContent || {};
                    data.dailyContent.visualization = defaultData.dailyContent.visualization;
                    data.dailyContent.gratitude = defaultData.dailyContent.gratitude;
                    
                    // Update section titles and reorder gratitude/visualization for default sections only
                    data.sections.forEach(section => {
                        if (section.id === 'meditation') {
                            section.title = 'Meditation';
                        } else if (section.id === 'reflections') {
                            section.title = 'Meditation Reflections';
                        } else if (section.id === 'visualization') {
                            section.title = 'Visualization of my goals';
                            section.order = 4; // Move after gratitude
                        } else if (section.id === 'gratitude') {
                            section.title = 'Gratitude for what\'s already here';
                            section.order = 3; // Move before visualization
                        }
                    });
                    
                    // Save updated data
                    localStorage.setItem('miracle-morning-data-version', DATA_VERSION.toString());
                    localStorage.setItem('miracle-morning-customizations', JSON.stringify(data));
                    
                    return data;
                }
                
                return data;
            }
            
            // First time - save version and return default data
            localStorage.setItem('miracle-morning-data-version', DATA_VERSION.toString());
            return JSON.parse(JSON.stringify(defaultData)); // Deep copy
        }

        // Save customizations to localStorage
        function saveCustomizations(data) {
            localStorage.setItem('miracle-morning-customizations', JSON.stringify(data));
        }

        // Get current customizations
        let customizations = loadCustomizations();

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const toggle = document.querySelector('.edit-mode-toggle');
            const container = document.querySelector('.container');
            
            if (editMode) {
                toggle.classList.add('active');
                toggle.textContent = '‚úì';
                container.classList.add('edit-mode');
            } else {
                toggle.classList.remove('active');
                toggle.textContent = '‚úèÔ∏è';
                container.classList.remove('edit-mode');
            }
            
            // Re-render to update draggable attributes
            renderRoutine();
        }

        // Render routine
        function renderRoutine() {
            const dayIndex = currentDayIndex;
            document.getElementById('dayDisplay').textContent = days[dayIndex];

            const sortedSections = [...customizations.sections].sort((a, b) => a.order - b.order);
            
            let routineHTML = '';
            sortedSections.forEach((section, index) => {
                const stepNum = index + 1;
                routineHTML += renderSection(section, stepNum, dayIndex);
            });

            document.getElementById('routine').innerHTML = routineHTML;
            loadCheckboxStates();
            updateDragHandlers();
        }

        // Render individual section
        function renderSection(section, stepNum, dayIndex) {
            let contentHTML = '';
            
            if (section.type === 'timer') {
                contentHTML = renderTimerSection();
            } else if (section.type === 'reflections') {
                contentHTML = renderReflectionsSection();
            } else if (section.type === 'daily') {
                const dayKey = 'day' + dayIndex;
                const content = customizations.dailyContent[section.id] && customizations.dailyContent[section.id][dayKey] 
                    ? customizations.dailyContent[section.id][dayKey] 
                    : '<p>No content for this day yet.</p>';
                contentHTML = content;
            } else if (section.type === 'simple') {
                contentHTML = `<p>${section.content}</p>`;
            }

            return `
                <div class="step" id="step-${stepNum}" data-section-id="${section.id}" draggable="${editMode}">
                    <div class="step-header">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <input type="checkbox" class="step-checkbox" id="checkbox-${stepNum}" onchange="toggleStep(${stepNum})">
                        <div class="step-title">${section.title}</div>
                        <button class="edit-btn" onclick="openEditModal('${section.id}')">‚úèÔ∏è</button>
                    </div>
                    <div class="step-content">
                        ${contentHTML}
                    </div>
                </div>
            `;
        }

        // Render timer section
        function renderTimerSection() {
            const presets = customizations.timerPresets;
            const presetsHTML = presets.map(min => 
                `<button class="timer-btn" onclick="startTimer(${min})">${min} min</button>`
            ).join('');

            return `
                <p id="bellAnnouncement" style="background: #FFF9E6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9em; color: #8B6914; display: none;">
                    üîî <strong>Bell Sound:</strong> Tap "Test Bell" to hear the meditation bell.
                </p>
                <div class="timer-controls">
                    ${presetsHTML}
                    <button class="timer-btn" onclick="showCustomTimer()">Custom</button>
                    <button class="edit-btn" onclick="openTimerPresetsModal()" style="opacity: 0;">‚öôÔ∏è</button>
                    <button onclick="playGongAndHideAnnouncement()" style="background: #E5E0D8; color: #5A5A5A; border: none; border-radius: 6px; cursor: pointer; font-size: 0.7em; padding: 6px 8px; margin: 0; width: 32px; min-width: 32px; max-width: 32px; opacity: 0.6; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; box-sizing: border-box;" onmouseover="this.style.background='#C49A93'; this.style.color='white';" onmouseout="this.style.background='#E5E0D8'; this.style.color='#5A5A5A';">üîî</button>
                </div>
                <div id="customTimerInput" style="display: none; margin-top: 16px;">
                    <input type="number" id="customMinutes" placeholder="Minutes" min="1" max="120" style="padding: 8px; border-radius: 8px; border: 1px solid #E5E0D8; width: 100px; margin-right: 8px;">
                    <button class="timer-btn" onclick="startCustomTimer()">Start</button>
                </div>
                <div id="timerDisplay" style="display: none; margin-top: 16px; text-align: center;">
                    <div style="font-size: 2.5em; font-weight: 600; color: #2D2D2D; margin-bottom: 12px;" id="timeRemaining">00:00</div>
                    <button class="timer-btn" onclick="stopTimer()" style="background: #B08580;">Stop</button>
                </div>
            `;
        }

        // Render reflections section
        function renderReflectionsSection() {
            const categories = customizations.reflectionCategories;
            const dayIndex = currentDayIndex;
            let html = '<div class="reflection-sections">';
            
            for (const [key, category] of Object.entries(categories)) {
                // Get daily selection (1-2 items) based on current day
                const dailyItems = getReflectionsForDay(key, category.items, dayIndex);
                const itemsHTML = dailyItems.map(item => 
                    `<div class="reflection-item">${item}</div>`
                ).join('');
                
                html += `
                    <div class="reflection-section">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="reflection-btn" onclick="toggleReflection('${key}')" style="flex: 1;">${category.title}</button>
                        </div>
                        <div id="${key}" class="reflection-content" style="display: none;">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Get 1-2 reflections for the current day from a category
        function getReflectionsForDay(categoryKey, items, dayIndex) {
            if (!items || items.length === 0) return [];
            
            // Always show 2 items if available, 1 if only 1 exists
            const count = Math.min(2, items.length);
            
            // Deterministic selection based on day and category
            const categoryHash = categoryKey.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            
            const selected = [];
            for (let i = 0; i < count; i++) {
                const index = (dayIndex * 3 + categoryHash * 2 + i) % items.length;
                // Avoid duplicates
                if (!selected.includes(items[index])) {
                    selected.push(items[index]);
                }
            }
            
            // If we didn't get enough unique items, add more
            if (selected.length < count && items.length >= count) {
                for (let offset = count; selected.length < count && offset < items.length + count; offset++) {
                    const index = (dayIndex * 3 + categoryHash * 2 + offset) % items.length;
                    if (!selected.includes(items[index])) {
                        selected.push(items[index]);
                    }
                }
            }
            
            return selected;
        }

        // Timer functions
        function startTimer(minutes) {
            startTimerWithMinutes(minutes);
        }

        function showCustomTimer() {
            document.getElementById('customTimerInput').style.display = 'block';
        }

        function startCustomTimer() {
            const minutes = parseInt(document.getElementById('customMinutes').value);
            if (minutes && minutes > 0) {
                startTimerWithMinutes(minutes);
                document.getElementById('customTimerInput').style.display = 'none';
            }
        }

        async function startTimerWithMinutes(minutes) {
            if (timerInterval) {
                stopTimer();
            }

            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake Lock not supported:', err);
            }

            let timeLeft = minutes * 60;
            document.getElementById('timerDisplay').style.display = 'block';
            
            updateTimerDisplay(timeLeft);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    stopTimer();
                    playGong();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timeRemaining').textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            
            document.getElementById('timerDisplay').style.display = 'none';
        }

        function playGong() {
            const audio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        function playGongAndHideAnnouncement() {
            playGong();
            const announcement = document.getElementById('bellAnnouncement');
            if (announcement) {
                announcement.style.display = 'none';
                localStorage.setItem('miracle-morning-bell-announced', 'true');
            }
        }

        function checkBellAnnouncement() {
            const announced = localStorage.getItem('miracle-morning-bell-announced');
            if (!announced) {
                const announcement = document.getElementById('bellAnnouncement');
                if (announcement) {
                    announcement.style.display = 'block';
                }
            }
        }

        // Reflection toggle
        function toggleReflection(id) {
            const content = document.getElementById(id);
            const btn = event.target;
            
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                btn.classList.add('active');
            } else {
                content.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        // Checkbox functions
        function toggleStep(stepNumber) {
            const checkbox = document.getElementById(`checkbox-${stepNumber}`);
            const step = document.getElementById(`step-${stepNumber}`);
            
            if (checkbox.checked) {
                step.classList.add('completed');
            } else {
                step.classList.remove('completed');
            }
            
            saveCheckboxStates();
        }

        function saveCheckboxStates() {
            const today = new Date().toDateString();
            const states = {};
            
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const checkbox = step.querySelector('.step-checkbox');
                if (checkbox) {
                    states[index + 1] = checkbox.checked;
                }
            });
            
            localStorage.setItem(`miracle-morning-${today}`, JSON.stringify(states));
        }

        function loadCheckboxStates() {
            const today = new Date().toDateString();
            const savedStates = localStorage.getItem(`miracle-morning-${today}`);
            
            if (savedStates) {
                const states = JSON.parse(savedStates);
                const steps = document.querySelectorAll('.step');
                
                steps.forEach((step, index) => {
                    const checkbox = step.querySelector('.step-checkbox');
                    if (checkbox && states[index + 1]) {
                        checkbox.checked = true;
                        step.classList.add('completed');
                    }
                });
            }
        }

        // Day navigation
        function nextDay() {
            currentDayIndex = (currentDayIndex + 1) % 7;
            renderRoutine();
        }

        function previousDay() {
            currentDayIndex = (currentDayIndex - 1 + 7) % 7;
            renderRoutine();
        }

        // Modal functions
        function openModal(content) {
            // Save current scroll position
            const scrollY = window.scrollY;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.add('active');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
        }

        function closeModal() {
            // Restore scroll position
            const scrollY = document.body.style.top;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
            
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function closeModalOnOverlayClick(event) {
            if (event.target.id === 'modalOverlay') {
                closeModal();
            }
        }

        // Edit section modal
        function openEditModal(sectionId) {
            if (!editMode) return;
            
            const section = customizations.sections.find(s => s.id === sectionId);
            if (!section) return;

            if (section.type === 'simple') {
                openSimpleTextModal(sectionId);
            } else if (section.type === 'daily') {
                openDailyContentModal(sectionId);
            } else if (section.type === 'timer') {
                openTimerPresetsModal();
            } else if (section.type === 'reflections') {
                openAllReflectionsModal();
            }
        }

        // Simple text section modal
        function openSimpleTextModal(sectionId) {
            const section = customizations.sections.find(s => s.id === sectionId);
            
            const content = `
                <h2>Edit Section</h2>
                <div class="form-group">
                    <label>Section Name</label>
                    <input type="text" id="editSectionTitle" value="${section.title}">
                </div>
                <div class="form-group">
                    <label>Instructions</label>
                    <textarea id="editSectionContent">${section.content}</textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn danger" onclick="handleDeleteSection('${sectionId}')">Delete Section</button>
                    <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="saveSimpleTextSection('${sectionId}')">Save</button>
                </div>
            `;
            
            openModal(content);
        }

        function saveSimpleTextSection(sectionId) {
            const section = customizations.sections.find(s => s.id === sectionId);
            section.title = document.getElementById('editSectionTitle').value;
            section.content = document.getElementById('editSectionContent').value;
            
            saveCustomizations(customizations);
            closeModal();
            renderRoutine();
        }

        // Daily content modal
        function openDailyContentModal(sectionId) {
            const section = customizations.sections.find(s => s.id === sectionId);
            if (!customizations.dailyContent[sectionId]) {
                customizations.dailyContent[sectionId] = {};
            }
            
            let tempDailyContent = JSON.parse(JSON.stringify(customizations.dailyContent[sectionId]));
            
            function renderAllDays() {
                // Get all day keys and sort them
                let dayKeys = Object.keys(tempDailyContent).sort((a, b) => {
                    const numA = parseInt(a.replace('day', ''));
                    const numB = parseInt(b.replace('day', ''));
                    return numA - numB;
                });
                
                // Ensure at least 7 days exist
                for (let i = 0; i < 7; i++) {
                    const dayKey = 'day' + i;
                    if (!dayKeys.includes(dayKey)) {
                        tempDailyContent[dayKey] = '';
                        dayKeys.push(dayKey);
                    }
                }
                dayKeys.sort((a, b) => {
                    const numA = parseInt(a.replace('day', ''));
                    const numB = parseInt(b.replace('day', ''));
                    return numA - numB;
                });
                
                let daysHTML = '';
                dayKeys.forEach(dayKey => {
                    const dayNum = parseInt(dayKey.replace('day', ''));
                    const dayName = days[dayNum] || `Day ${dayNum + 1}`;
                    
                    // Strip HTML tags from content for plain text editing
                    let content = tempDailyContent[dayKey] || '';
                    content = content.replace(/<[^>]*>/g, '').trim();
                    
                    daysHTML += `
                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #E5E0D8;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: 600; color: #2D2D2D;">${dayName}</label>
                                ${dayNum >= 7 ? `<button class="delete-item-btn" onclick="deleteDayTemp('${dayKey}')" style="width: 32px; height: 32px;">√ó</button>` : ''}
                            </div>
                            <textarea onchange="updateDayContent('${dayKey}', this.value)" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #E5E0D8; border-radius: 8px; font-family: inherit; resize: vertical;">${content}</textarea>
                        </div>
                    `;
                });
                
                const content = `
                    <div style="display: flex; flex-direction: column; height: 75vh;">
                        <div style="margin-bottom: 12px;">
                            <h2 style="margin-bottom: 8px;">Edit ${section.title}</h2>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Section Name</label>
                                <input type="text" id="editDailySectionTitle" value="${section.title}">
                            </div>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding-right: 8px;">
                            ${daysHTML}
                            <button class="add-item-btn" onclick="addNewDayTemp()">+ Add Another Day</button>
                        </div>
                        <div class="modal-buttons" style="position: sticky; bottom: 0; background: #F5F1EA; padding-top: 12px; margin-top: 12px; border-top: 1px solid #E5E0D8;">
                            <button class="modal-btn danger" onclick="handleDeleteSection('${sectionId}')">Delete Section</button>
                            <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                            <button class="modal-btn primary" onclick="saveAllDailyContent('${sectionId}')">Save All</button>
                        </div>
                    </div>
                `;
                
                openModal(content);
            }
            
            window.updateDayContent = function(dayKey, value) {
                tempDailyContent[dayKey] = value;
            };
            
            window.deleteDayTemp = function(dayKey) {
                showConfirmDialog(
                    'Delete this day\'s content?',
                    () => {
                        delete tempDailyContent[dayKey];
                        renderAllDays();
                    }
                );
            };
            
            window.addNewDayTemp = function() {
                // Find the highest day number
                let maxDay = -1;
                for (const key in tempDailyContent) {
                    const dayNum = parseInt(key.replace('day', ''));
                    if (dayNum > maxDay) maxDay = dayNum;
                }
                const newDayKey = 'day' + (maxDay + 1);
                tempDailyContent[newDayKey] = '';
                renderAllDays();
            };
            
            window.saveAllDailyContent = function(sectionId) {
                const section = customizations.sections.find(s => s.id === sectionId);
                section.title = document.getElementById('editDailySectionTitle').value;
                
                // Save content as plain paragraphs (no HTML except <p> tags)
                const savedContent = {};
                for (const [dayKey, content] of Object.entries(tempDailyContent)) {
                    if (content && content.trim()) {
                        savedContent[dayKey] = `<p>${content.trim()}</p>`;
                    }
                }
                
                customizations.dailyContent[sectionId] = savedContent;
                saveCustomizations(customizations);
                closeModal();
                renderRoutine();
            };
            
            renderAllDays();
        }

        // Timer presets modal
        function openTimerPresetsModal() {
            if (!editMode) return;
            
            let tempPresets = [...customizations.timerPresets];
            
            function renderPresets() {
                let presetsHTML = '';
                tempPresets.forEach((preset, index) => {
                    presetsHTML += `
                        <div class="item-row">
                            <input type="number" value="${preset}" id="preset-${index}" min="1" max="120" onchange="updateTempPreset(${index}, this.value)">
                            <button class="delete-item-btn" onclick="deleteTempPreset(${index})">√ó</button>
                        </div>
                    `;
                });
                
                const content = `
                    <h2>Edit Timer Presets</h2>
                    <div class="form-group">
                        <label>Timer Presets (minutes)</label>
                        <div class="item-list">
                            ${presetsHTML}
                        </div>
                        <button class="add-item-btn" onclick="addTempPreset()">+ Add Preset</button>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                        <button class="modal-btn primary" onclick="saveTimerPresets()">Save</button>
                    </div>
                `;
                
                openModal(content);
            }
            
            window.updateTempPreset = function(index, value) {
                const numValue = parseInt(value);
                if (numValue > 0) {
                    tempPresets[index] = numValue;
                }
            };
            
            window.addTempPreset = function() {
                tempPresets.push(15);
                renderPresets();
            };
            
            window.deleteTempPreset = function(index) {
                tempPresets.splice(index, 1);
                renderPresets();
            };
            
            window.saveTimerPresets = function() {
                customizations.timerPresets = [...tempPresets];
                saveCustomizations(customizations);
                closeModal();
                renderRoutine();
            };
            
            renderPresets();
        }

        // Reflection category modal
        function openAllReflectionsModal() {
            if (!editMode) return;
            
            let tempCategories = JSON.parse(JSON.stringify(customizations.reflectionCategories));
            
            function renderAllReflections(preserveScroll = false) {
                // Save scroll position if preserving
                let scrollPos = 0;
                if (preserveScroll) {
                    const scrollContainer = document.querySelector('[data-scroll-container]');
                    if (scrollContainer) {
                        scrollPos = scrollContainer.scrollTop;
                    }
                }
                
                let categoriesHTML = '';
                
                for (const [key, category] of Object.entries(tempCategories)) {
                    let itemsHTML = '';
                    category.items.forEach((item, index) => {
                        itemsHTML += `
                            <div style="background: #FAF8F4; padding: 14px 16px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #E5E0D8; display: flex; gap: 10px; align-items: start; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#C49A93'" onmouseout="this.style.borderColor='#E5E0D8'">
                                <span style="color: #C49A93; font-weight: 600; font-size: 0.9em; margin-top: 2px; min-width: 20px;">${index + 1}.</span>
                                <textarea onchange="updateReflectionItemInPlace('${key}', ${index}, this.value)" oninput="autoResizeTextarea(this)" style="flex: 1; border: none; background: transparent; font-size: 0.95em; font-family: inherit; resize: none; padding: 0; color: #2D2D2D; line-height: 1.5; min-height: 24px; overflow: hidden;" rows="1">${item}</textarea>
                                <button onclick="event.stopPropagation(); deleteReflectionItemTemp('${key}', ${index}); return false;" style="background: transparent; border: none; color: #B08580; cursor: pointer; font-size: 1.2em; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s ease; flex-shrink: 0;" onmouseover="this.style.background='#FFE5E5'; this.style.color='#d68a7f'" onmouseout="this.style.background='transparent'; this.style.color='#B08580'">√ó</button>
                            </div>
                        `;
                    });
                    
                    categoriesHTML += `
                        <div style="background: white; padding: 24px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #E5E0D8; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                            <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
                                <input type="text" value="${category.title}" onchange="updateCategoryTitleInPlace('${key}', this.value)" style="flex: 1; font-weight: 600; font-size: 1.1em; padding: 12px 16px; border: 2px solid #E5E0D8; border-radius: 10px; background: #F5F1EA; transition: all 0.2s ease;" onfocus="this.style.borderColor='#C49A93'; this.style.background='white'" onblur="this.style.borderColor='#E5E0D8'; this.style.background='#F5F1EA'">
                                <button onclick="event.stopPropagation(); deleteCategoryTemp('${key}'); return false;" style="background: #FFE5E5; border: none; color: #d68a7f; cursor: pointer; font-size: 1.1em; padding: 10px 14px; border-radius: 10px; transition: all 0.2s ease; font-weight: 500; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#d68a7f'; this.style.color='white'" onmouseout="this.style.background='#FFE5E5'; this.style.color='#d68a7f'">√ó</button>
                            </div>
                            <div style="margin-left: 0;">
                                ${itemsHTML}
                                <button onclick="event.stopPropagation(); addReflectionItemTemp('${key}'); return false;" style="background: #F5F1EA; border: 2px dashed #C49A93; color: #C49A93; cursor: pointer; padding: 12px; border-radius: 10px; font-size: 0.9em; font-weight: 500; width: 100%; transition: all 0.2s ease; margin-top: 4px;" onmouseover="this.style.background='#C49A93'; this.style.color='white'; this.style.borderStyle='solid'" onmouseout="this.style.background='#F5F1EA'; this.style.color='#C49A93'; this.style.borderStyle='dashed'">+ Add Reflection</button>
                            </div>
                        </div>
                    `;
                }
                
                const content = `
                    <h2 style="margin-bottom: 8px;">Edit Reflections</h2>
                    <p style="color: #5A5A5A; font-size: 0.9em; margin-bottom: 24px;">Edit categories and reflection items below</p>
                    <div data-scroll-container style="max-height: 55vh; overflow-y: auto; margin: 0 -8px; padding: 0 8px;">
                        ${categoriesHTML}
                        <button onclick="event.stopPropagation(); addNewCategoryTemp(); return false;" style="background: #F5F1EA; border: 2px dashed #C49A93; color: #C49A93; cursor: pointer; padding: 16px; border-radius: 12px; font-size: 0.95em; font-weight: 500; width: 100%; transition: all 0.2s ease; margin-top: 0;" onmouseover="this.style.background='#C49A93'; this.style.color='white'; this.style.borderStyle='solid'" onmouseout="this.style.background='#F5F1EA'; this.style.color='#C49A93'; this.style.borderStyle='dashed'">+ Add New Category</button>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                        <button class="modal-btn primary" onclick="saveAllReflections()">Save All</button>
                    </div>
                `;
                
                // If this is the first render or modal is not open, open it properly
                const modalOverlay = document.getElementById('modalOverlay');
                if (!preserveScroll || !modalOverlay.classList.contains('active')) {
                    openModal(content);
                } else {
                    // Just update content and preserve scroll
                    const modalContent = document.getElementById('modalContent');
                    modalContent.innerHTML = content;
                }
                
                // Restore scroll position immediately if preserving
                if (preserveScroll && scrollPos > 0) {
                    const scrollContainer = document.querySelector('[data-scroll-container]');
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollPos;
                    }
                }
                
                // Auto-resize all textareas after modal opens
                setTimeout(() => {
                    document.querySelectorAll('textarea').forEach(textarea => {
                        autoResizeTextarea(textarea);
                    });
                }, 10);
            }
            
            window.autoResizeTextarea = function(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            };
            
            window.updateCategoryTitleInPlace = function(key, value) {
                tempCategories[key].title = value;
                // Don't re-render, just update in memory
            };
            
            window.updateReflectionItemInPlace = function(key, index, value) {
                tempCategories[key].items[index] = value;
                // Don't re-render, just update in memory
            };
            
            window.addReflectionItemTemp = function(key) {
                tempCategories[key].items.push('New reflection...');
                renderAllReflections(true); // Preserve scroll when adding
            };
            
            window.deleteReflectionItemTemp = function(key, index) {
                if (tempCategories[key].items.length <= 1) {
                    showAlert('Each category must have at least one reflection item.');
                    return;
                }
                // Remove from data
                tempCategories[key].items.splice(index, 1);
                
                // Just re-render to update numbering, but preserve scroll
                renderAllReflections(true);
            };
            
            window.deleteCategoryTemp = function(key) {
                const numCategories = Object.keys(tempCategories).length;
                if (numCategories <= 1) {
                    showAlert('You must keep at least one reflection category.');
                    return;
                }
                
                showConfirmDialog(
                    'Delete this entire category and all its reflections?',
                    () => {
                        // Delete from both temp and actual customizations
                        delete tempCategories[key];
                        delete customizations.reflectionCategories[key];
                        saveCustomizations(customizations);
                        
                        // Refresh the main page and stay there
                        renderRoutine();
                    }
                );
            };
            
            window.addNewCategoryTemp = function() {
                const newKey = 'category' + Date.now();
                tempCategories[newKey] = {
                    title: 'New Category',
                    items: ['New reflection...']
                };
                renderAllReflections(true); // Preserve scroll when adding
            };
            
            window.saveAllReflections = function() {
                customizations.reflectionCategories = JSON.parse(JSON.stringify(tempCategories));
                saveCustomizations(customizations);
                closeModal();
                renderRoutine();
            };
            
            renderAllReflections(false); // Initial render, no scroll to preserve
        }
        
        function openReflectionCategoryModal(categoryKey) {
            // This function is now unused but kept for compatibility
            openAllReflectionsModal();
        }

        // Add new section
        function openAddSectionModal() {
            if (!editMode) return;
            
            let step = 1;
            let newSectionData = {
                title: '',
                type: 'simple',
                content: '',
                dailyContent: {}
            };
            
            function renderStep1() {
                const content = `
                    <h2>Add New Section</h2>
                    <div class="form-group">
                        <label>Section Name</label>
                        <input type="text" id="newSectionTitle" placeholder="e.g., Affirmations" value="${newSectionData.title}">
                    </div>
                    <div class="form-group">
                        <label>Section Type</label>
                        <select id="newSectionType" onchange="updateSectionType(this.value)">
                            <option value="simple" ${newSectionData.type === 'simple' ? 'selected' : ''}>Simple Text (e.g. instructions)</option>
                            <option value="daily" ${newSectionData.type === 'daily' ? 'selected' : ''}>Daily Rotation</option>
                        </select>
                    </div>
                    <div class="form-group" id="simpleContentGroup" style="display: none;">
                        <label>Initial Content</label>
                        <textarea id="newSectionContent" placeholder="Enter the content...">${newSectionData.content}</textarea>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                        <button class="modal-btn primary" onclick="proceedToStep2()">Next ‚Üí</button>
                    </div>
                `;
                
                openModal(content);
                
                // Set initial visibility based on type
                setTimeout(() => {
                    updateSectionType(newSectionData.type);
                }, 0);
            }
            
            function renderStep2() {
                let daysHTML = '';
                for (let i = 0; i < 7; i++) {
                    const dayKey = 'day' + i;
                    const content = newSectionData.dailyContent[dayKey] || '';
                    
                    daysHTML += `
                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #E5E0D8;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: 600; color: #2D2D2D;">${days[i]}</label>
                            </div>
                            <textarea id="day${i}Content" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #E5E0D8; border-radius: 8px; font-family: inherit; resize: vertical;">${content}</textarea>
                        </div>
                    `;
                }
                
                const content = `
                    <h2>Edit ${newSectionData.title}</h2>
                    <p style="color: #5A5A5A; font-size: 0.9em; margin-bottom: 20px;">Enter content for each day of the week</p>
                    <div style="max-height: 50vh; overflow-y: auto; margin: 0 -8px; padding: 0 8px;">
                        ${daysHTML}
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn secondary" onclick="backToStep1()">‚Üê Back</button>
                        <button class="modal-btn primary" onclick="createDailySection()">Create Section</button>
                    </div>
                `;
                
                openModal(content);
            }
            
            window.updateSectionType = function(type) {
                newSectionData.type = type;
                const simpleContentGroup = document.getElementById('simpleContentGroup');
                const nextButton = document.querySelector('.modal-btn.primary');
                
                if (type === 'simple') {
                    if (simpleContentGroup) simpleContentGroup.style.display = 'block';
                    if (nextButton) nextButton.textContent = 'Create';
                } else {
                    if (simpleContentGroup) simpleContentGroup.style.display = 'none';
                    if (nextButton) nextButton.textContent = 'Next ‚Üí';
                }
            };
            
            window.proceedToStep2 = function() {
                const title = document.getElementById('newSectionTitle').value.trim();
                const type = document.getElementById('newSectionType').value;
                
                if (!title) {
                    showAlert('Please enter a section name');
                    return;
                }
                
                newSectionData.title = title;
                newSectionData.type = type;
                
                if (type === 'simple') {
                    const content = document.getElementById('newSectionContent').value.trim();
                    newSectionData.content = content;
                    createSimpleSection();
                } else {
                    step = 2;
                    renderStep2();
                }
            };
            
            window.backToStep1 = function() {
                // Save current daily content before going back
                for (let i = 0; i < 7; i++) {
                    const textarea = document.getElementById(`day${i}Content`);
                    if (textarea) {
                        newSectionData.dailyContent['day' + i] = textarea.value;
                    }
                }
                step = 1;
                renderStep1();
            };
            
            window.createSimpleSection = function() {
                const id = newSectionData.title.toLowerCase().replace(/[^a-z0-9]/g, '') + Date.now();
                const maxOrder = Math.max(...customizations.sections.map(s => s.order));
                
                const newSection = {
                    id: id,
                    title: newSectionData.title,
                    type: 'simple',
                    order: maxOrder + 1,
                    content: newSectionData.content
                };
                
                customizations.sections.push(newSection);
                saveCustomizations(customizations);
                closeModal();
                renderRoutine();
            };
            
            window.createDailySection = function() {
                // Collect all daily content
                const dailyContent = {};
                for (let i = 0; i < 7; i++) {
                    const textarea = document.getElementById(`day${i}Content`);
                    if (textarea && textarea.value.trim()) {
                        dailyContent['day' + i] = `<p>${textarea.value.trim()}</p>`;
                    }
                }
                
                const id = newSectionData.title.toLowerCase().replace(/[^a-z0-9]/g, '') + Date.now();
                const maxOrder = Math.max(...customizations.sections.map(s => s.order));
                
                const newSection = {
                    id: id,
                    title: newSectionData.title,
                    type: 'daily',
                    order: maxOrder + 1
                };
                
                customizations.sections.push(newSection);
                customizations.dailyContent[id] = dailyContent;
                
                saveCustomizations(customizations);
                closeModal();
                renderRoutine();
            };
            
            renderStep1();
        }

        // Custom confirmation dialog (replaces confirm())
        let pendingConfirmCallback = null;
        
        function showConfirmDialog(message, onConfirm) {
            pendingConfirmCallback = onConfirm;
            const content = `
                <h2 style="margin-bottom: 16px; color: #d68a7f;">‚ö†Ô∏è Warning</h2>
                <div style="color: #2D2D2D; font-size: 0.95em; margin-bottom: 24px; line-height: 1.7;">${message}</div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeConfirmDialog()">Cancel</button>
                    <button class="modal-btn danger" onclick="executeConfirm()">Confirm</button>
                </div>
            `;
            openModal(content);
        }
        
        function executeConfirm() {
            if (pendingConfirmCallback) {
                pendingConfirmCallback();
                pendingConfirmCallback = null;
            }
            closeModal();
        }

        function closeConfirmDialog() {
            pendingConfirmCallback = null;
            closeModal();
        }

        // Custom alert dialog (replaces alert())
        function showAlert(message) {
            const content = `
                <h2 style="margin-bottom: 16px;">Notice</h2>
                <p style="color: #5A5A5A; font-size: 0.95em; margin-bottom: 24px; line-height: 1.6;">${message}</p>
                <div class="modal-buttons">
                    <button class="modal-btn primary" onclick="closeModal()" style="width: 100%;">OK</button>
                </div>
            `;
            openModal(content);
        }

        // Delete section wrapper
        function handleDeleteSection(sectionId) {
            const section = customizations.sections.find(s => s.id === sectionId);
            if (!section) {
                showAlert('Section not found. Please refresh and try again.');
                return;
            }
            
            showConfirmDialog(
                `Delete "${section.title}" section permanently?`,
                () => confirmDeleteSection(sectionId)
            );
        }

        function confirmDeleteSection(sectionId) {
            customizations.sections = customizations.sections.filter(s => s.id !== sectionId);
            
            // Also delete associated daily content if exists
            if (customizations.dailyContent[sectionId]) {
                delete customizations.dailyContent[sectionId];
            }
            
            saveCustomizations(customizations);
            renderRoutine();
        }

        // Delete section
        function deleteSection(sectionId) {
            handleDeleteSection(sectionId);
        }

        // Drag and drop functionality
        function updateDragHandlers() {
            const steps = document.querySelectorAll('.step');
            
            steps.forEach(step => {
                step.addEventListener('dragstart', handleDragStart);
                step.addEventListener('dragend', handleDragEnd);
                step.addEventListener('dragover', handleDragOver);
                step.addEventListener('drop', handleDrop);
                step.addEventListener('dragenter', handleDragEnter);
                step.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            if (!editMode) return;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (!editMode) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (!editMode || this === draggedElement) return;
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (!editMode) return;
            e.stopPropagation();
            e.preventDefault();
            
            if (draggedElement !== this) {
                // Get section IDs
                const draggedId = draggedElement.dataset.sectionId;
                const targetId = this.dataset.sectionId;
                
                // Find sections
                const draggedSection = customizations.sections.find(s => s.id === draggedId);
                const targetSection = customizations.sections.find(s => s.id === targetId);
                
                // Swap orders
                const tempOrder = draggedSection.order;
                draggedSection.order = targetSection.order;
                targetSection.order = tempOrder;
                
                saveCustomizations(customizations);
                renderRoutine();
            }
            
            return false;
        }

        // Reset to default
        function confirmReset() {
            showConfirmDialog(
                `This will delete <strong>ALL</strong> your customizations including:
                <ul style="margin: 12px 0 12px 20px; text-align: left;">
                    <li style="margin-bottom: 8px;">Custom sections</li>
                    <li style="margin-bottom: 8px;">Edited reflections</li>
                    <li style="margin-bottom: 8px;">Daily content</li>
                </ul>
                <strong>This cannot be undone.</strong>`,
                () => {
                    customizations = JSON.parse(JSON.stringify(defaultData));
                    saveCustomizations(customizations);
                    renderRoutine();
                }
            );
        }

        // Initialize
        renderRoutine();
        checkBellAnnouncement();
    </script>
</body>
</html>
